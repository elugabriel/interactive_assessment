{% extends "base.html" %}
{% block title %}Exam{% endblock %}

{% block content %}
<h2>Exam ID: {{ exam.id }}</h2>
<p>Time Remaining: <span id="timer"></span></p>

<div id="exam-container" style="margin-top:20px;">
    <div id="question-area"></div>

    <div style="margin-top:15px;">
        <button id="prevBtn" style="padding:8px 16px;">Previous</button>
        <button id="nextBtn" style="padding:8px 16px;">Next</button>
    </div>

    <div id="question-progress" style="margin-top:20px;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let examId = {{ exam.id }};
let timeRemaining = {{ time_remaining }};
let timerInterval;

let questions = [];  // store questions from API
let answers = {};    // store student answers
let currentIndex = 0;

// ----------------- TIMER -----------------
function startTimer() {
    const timerElem = document.getElementById("timer");
    timerInterval = setInterval(() => {
        if(timeRemaining <= 0){
            clearInterval(timerInterval);
            submitExam();
            return;
        }
        let mins = Math.floor(timeRemaining / 60);
        let secs = timeRemaining % 60;
        timerElem.textContent = mins + ":" + (secs < 10 ? "0"+secs : secs);
        timeRemaining--;
    }, 1000);
}

// ----------------- LOAD QUESTIONS -----------------
async function loadQuestions() {
    const resp = await fetch(`/api/exam_questions/${examId}`);
    const data = await resp.json();
    questions = data.questions;

    // initialize empty answers
    questions.forEach(q => answers[q.question_id] = "");

    renderQuestion();
    renderProgress();
    updateNavButtons();
}

// ----------------- RENDER QUESTION -----------------
function renderQuestion() {
    const container = document.getElementById("question-area");
    const q = questions[currentIndex];

    container.innerHTML = `
        <p><b>Question ${q.question_order}:</b></p>
        <pre style="
            white-space: pre-wrap;
            background:#f7f7f7;
            padding:10px;
            border-radius:5px;
            border:1px solid #ddd;
            font-size:16px;
            line-height:1.4;
        ">${q.question_text}</pre>

        <textarea id="answerBox" rows="4" cols="80"
            style="margin-top:10px; padding:10px; font-size:15px;">${answers[q.question_id]}</textarea>
    `;

    // Update progress color when typing
    document.getElementById("answerBox").addEventListener("input", (e) => {
        answers[q.question_id] = e.target.value.trim();
        updateProgressColor();
        updateNavButtons();
    });
}

// ----------------- NAVIGATION -----------------
function updateNavButtons() {
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    prevBtn.disabled = currentIndex === 0;

    if(currentIndex === questions.length - 1){
        nextBtn.textContent = "Submit";
    } else {
        nextBtn.textContent = "Next";
    }
}

document.getElementById("prevBtn").onclick = () => {
    if(currentIndex > 0){
        currentIndex--;
        renderQuestion();
        updateNavButtons();
    }
};

document.getElementById("nextBtn").onclick = () => {
    if(currentIndex < questions.length - 1){
        currentIndex++;
        renderQuestion();
        updateNavButtons();
    } else {
        submitExam();
    }
};

// ----------------- PROGRESS -----------------
function renderProgress() {
    const progContainer = document.getElementById("question-progress");
    progContainer.innerHTML = "";

    questions.forEach((q, idx) => {
        const span = document.createElement("span");
        span.textContent = q.question_order;
        span.style.display = "inline-block";
        span.style.width = "30px";
        span.style.height = "30px";
        span.style.margin = "3px";
        span.style.lineHeight = "30px";
        span.style.textAlign = "center";
        span.style.border = "1px solid #004080";
        span.style.borderRadius = "50%";
        span.style.cursor = "pointer";
        span.style.backgroundColor = answers[q.question_id] ? "#28a745" : "#fff";
        span.style.color = answers[q.question_id] ? "#fff" : "#004080";
        span.addEventListener("click", () => {
            currentIndex = idx;
            renderQuestion();
            updateNavButtons();
        });
        progContainer.appendChild(span);
    });
}

function updateProgressColor() {
    const spans = document.getElementById("question-progress").children;
    questions.forEach((q, idx) => {
        const span = spans[idx];
        if(answers[q.question_id]){
            span.style.backgroundColor = "#28a745";
            span.style.color = "#fff";
        } else {
            span.style.backgroundColor = "#fff";
            span.style.color = "#004080";
        }
    });
}

// ----------------- SUBMIT EXAM -----------------
async function submitExam() {
    const payload = {answers: []};
    for(const qid in answers){
        payload.answers.push({question_id: qid, answer: answers[qid]});
    }

    try {
        const resp = await fetch(`/submit_exam/${examId}`, {
            method:"POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(payload)
        });
        const result = await resp.json();
        if(result.redirect){
            window.location.href = result.redirect;
        } else {
            alert("Submission failed.");
        }
    } catch(err){
        console.error(err);
        alert("Error submitting exam.");
    }
}

// ----------------- INIT -----------------
window.onload = () => {
    startTimer();
    loadQuestions();
};
</script>
{% endblock %}
