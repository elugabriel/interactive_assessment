{% extends "base.html" %}
{% block title %}Exam Results{% endblock %}

{% block content %}
<div class="container results-page">
    <h2>Exam {{ exam.id }} Results</h2>

    <!-- Summary Boxes -->
    <div class="summary-container" style="display:flex; gap:20px; margin:20px 0;">
        <div class="summary-box correct-box" style="flex:1; background:#d4edda; color:#155724; padding:15px; border-radius:8px; text-align:center;">
            <p class="summary-title" style="font-weight:bold;">Correct</p>
            <p class="summary-value" style="font-size:24px; margin-top:5px;">
                {{ results|selectattr('is_correct', 'equalto', true)|list|length }}
            </p>
        </div>
        <div class="summary-box wrong-box" style="flex:1; background:#f8d7da; color:#721c24; padding:15px; border-radius:8px; text-align:center;">
            <p class="summary-title" style="font-weight:bold;">Wrong</p>
            <p class="summary-value" style="font-size:24px; margin-top:5px;">
                {{ results|selectattr('is_correct', 'equalto', false)|list|length }}
            </p>
        </div>
        <div class="summary-box unanswered-box" style="flex:1; background:#fff3cd; color:#856404; padding:15px; border-radius:8px; text-align:center;">
            <p class="summary-title" style="font-weight:bold;">Unanswered</p>
            <p class="summary-value" style="font-size:24px; margin-top:5px;">
                {{ results|selectattr('student_answer', 'equalto', '')|list|length }}
            </p>
        </div>
    </div>

    <!-- Detailed Answers -->
    <h3>Answers</h3>
    <ul style="list-style:none; padding-left:0;">
        {% for r in results %}
        <li style="margin-bottom:15px; padding:10px; border-radius:6px; border:1px solid #ccc; background:#f9f9f9;">
            <p style="margin-bottom:5px; font-weight:bold;">Question {{ loop.index }}:</p>
            <pre style="white-space: pre-wrap; font-family:inherit; background:#f7f7f7; padding:8px; border-radius:4px; border:1px solid #ddd;">{{ r.question_text }}</pre>
            <p>Your Answer: <span style="font-weight:bold; color:{{ 'green' if r.is_correct else 'red' }};">{{ r.student_answer if r.student_answer else 'Unanswered' }}</span></p>
            <p>Correct Answer: <span style="font-weight:bold; color:#004080;">{{ r.correct_answer }}</span></p>
        </li>
        {% endfor %}
    </ul>

    <!-- Topic Summary Chart -->
    <h3>Topic Summary</h3>
    <canvas id="topicChart" width="600" height="400" style="margin-top:15px;"></canvas>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function drawChart() {
    const resp = await fetch(`/api/results_data/{{ exam.id }}`);
    const data = await resp.json();
    const ctx = document.getElementById('topicChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.topics,
            datasets: [{
                label: 'Correct Answers',
                data: data.topic_correct,
                backgroundColor: 'rgba(75, 192, 192, 0.6)'
            }, {
                label: 'Total Questions',
                data: data.topic_total,
                backgroundColor: 'rgba(192, 75, 75, 0.4)'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Performance by Topic' }
            },
            scales: { y: { beginAtZero:true } }
        }
    });
}
drawChart();
</script>
{% endblock %}
